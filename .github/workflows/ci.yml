name: CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main ]

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - uses: actions/setup-ruby@v1
      with:
        ruby-version: '4.0.1'
        bundle-cache: true

    - name: Bundle Install
      run: bundle install -j 4

    - name: Validate sample game against JSON schema
      run: |
        make validate-json

  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc g++ make cmake

    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install gcc make cmake

    - name: Build Google Test
      run: |
        make googletest

    - name: Verify Google Test libraries
      run: |
        ls -la tests/googletest/build/lib/
        file tests/googletest/build/lib/libgtest.a
        file tests/googletest/build/lib/libgtest_main.a

    - name: Build project
      run: |
        make -j 4 all

    - name: Run tests
      run: |
        make tests

    - name: Test binary execution
      run: |
        # Test that the binary runs and shows help
        ./gomoku --help
        
        # Test that the binary can be invoked with various flags
        timeout 5s ./gomoku --level easy --board 15 || true
        echo "Binary execution test completed"

    - name: Check for memory leaks (Ubuntu only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get install -y valgrind
        # Run a quick memory check on the test binary
        valgrind --leak-check=summary --error-exitcode=1 ./test_gomoku || echo "Memory check completed" 

