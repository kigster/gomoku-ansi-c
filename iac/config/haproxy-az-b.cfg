# haproxy-az-b.cfg - HAProxy configuration for Load Balancer in AZ-b
# Primary backend: Gomoku cluster in AZ-b
# Backup backend: Gomoku cluster in AZ-a (overflow only)
#
# This config is for running 5 HAProxy processes on the same port using SO_REUSEPORT
# Start with: haproxy -f haproxy-az-b.cfg -W -S /var/run/haproxy-master.sock

global
    log stdout format raw local0
    maxconn 4096
    # Enable SO_REUSEPORT for multi-process mode
    stats socket /var/run/haproxy.sock mode 660 level admin
    # Number of processes (match CPU count or desired concurrency)
    nbproc 5
    
defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout queue 60s
    default-server inter 3s fall 3 rise 2

# =========================================================================
# Frontend - receives requests from nginx on localhost
# =========================================================================
frontend gomoku_frontend
    bind 127.0.0.1:10000
    
    # Default backend
    default_backend gomoku_primary

# =========================================================================
# Primary Backend - Gomoku cluster in AZ-b (same availability zone)
# Uses agent-check for accurate busy/ready status
# =========================================================================
backend gomoku_primary
    # Use leastconn algorithm - routes to server with fewest active connections
    # Combined with agent-check, this effectively routes to the "least busy" server
    balance leastconn
    
    # Health check via HTTP
    option httpchk GET /health
    http-check expect status 200
    
    # AZ-b servers (PRIMARY) - 5 gomoku-httpd instances
    # agent-check queries port 8788 for ready/drain status
    # weight 100 = normal priority
    server gomoku-b1 10.0.2.10:8787 check agent-check agent-port 8788 agent-inter 1s weight 100
    server gomoku-b2 10.0.2.11:8787 check agent-check agent-port 8788 agent-inter 1s weight 100
    server gomoku-b3 10.0.2.12:8787 check agent-check agent-port 8788 agent-inter 1s weight 100
    server gomoku-b4 10.0.2.13:8787 check agent-check agent-port 8788 agent-inter 1s weight 100
    server gomoku-b5 10.0.2.14:8787 check agent-check agent-port 8788 agent-inter 1s weight 100
    
    # AZ-a servers (BACKUP) - only used when all AZ-b servers are busy/down
    # The 'backup' keyword means these are only used when primary servers unavailable
    server gomoku-a1 10.0.1.10:8787 check agent-check agent-port 8788 agent-inter 1s weight 100 backup
    server gomoku-a2 10.0.1.11:8787 check agent-check agent-port 8788 agent-inter 1s weight 100 backup
    server gomoku-a3 10.0.1.12:8787 check agent-check agent-port 8788 agent-inter 1s weight 100 backup
    server gomoku-a4 10.0.1.13:8787 check agent-check agent-port 8788 agent-inter 1s weight 100 backup
    server gomoku-a5 10.0.1.14:8787 check agent-check agent-port 8788 agent-inter 1s weight 100 backup

# =========================================================================
# Statistics page (optional, for monitoring)
# =========================================================================
frontend stats
    bind 127.0.0.1:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST
