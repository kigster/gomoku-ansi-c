# haproxy-az-a.cfg - HAProxy configuration for Load Balancer in AZ-a
# Primary backend: Gomoku cluster in AZ-a
# Backup backend: Gomoku cluster in AZ-b (overflow only)
#
# This config is for running 5 HAProxy processes on the same port using SO_REUSEPORT
# Start with: haproxy -f haproxy-az-a.cfg -W -S /var/run/haproxy-master.sock

global
    log stdout format raw local0
    maxconn 1100
    # Enable SO_REUSEPORT for multi-process mode
    stats socket /var/run/haproxy.sock mode 660 level admin
    
defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout queue 600s
    default-server inter 2s fall 2 rise 1

# =========================================================================
# Frontend - receives requests from nginx on localhost
# =========================================================================
frontend gomoku_frontend
    bind 127.0.0.1:10000
    
    # Default backend
    default_backend gomoku_primary

# =========================================================================
# Primary Backend - Gomoku cluster in AZ-a (same availability zone)
# Uses agent-check for accurate busy/ready status
# =========================================================================
backend gomoku_primary
    # Use leastconn algorithm - routes to server with fewest active connections
    # Combined with agent-check, this effectively routes to the "least busy" server
    balance leastconn
    timeout server 600000ms
    
    # Health check via HTTP
    # option httpchk GET /health
    # http-check expect status 200
    
    # AZ-a servers (PRIMARY) - 5 gomoku-httpd instances
    # agent-check dynamically sets maxconn: 10 when idle, 1 when busy
    # This allows HAProxy to queue excess requests instead of returning 503
    server gomoku-a1 127.0.0.1:9500 check agent-check agent-port 9600 agent-inter 1s weight 100
    server gomoku-a2 127.0.0.1:9501 check agent-check agent-port 9601 agent-inter 1s weight 100
    server gomoku-a3 127.0.0.1:9502 check agent-check agent-port 9602 agent-inter 1s weight 100
    server gomoku-a4 127.0.0.1:9503 check agent-check agent-port 9603 agent-inter 1s weight 100
    server gomoku-a5 127.0.0.1:9504 check agent-check agent-port 9604 agent-inter 1s weight 100

    # AZ-b servers (BACKUP) - only used when all AZ-a servers are busy/down
    server gomoku-b1 127.0.0.1:9505 check agent-check agent-port 9605 agent-inter 1s weight 100
    server gomoku-b2 127.0.0.1:9506 check agent-check agent-port 9606 agent-inter 1s weight 100
    server gomoku-b3 127.0.0.1:9507 check agent-check agent-port 9607 agent-inter 1s weight 100
    server gomoku-b4 127.0.0.1:9508 check agent-check agent-port 9608 agent-inter 1s weight 100
    server gomoku-b5 127.0.0.1:9509 check agent-check agent-port 9609 agent-inter 1s weight 100

# =========================================================================
# Statistics page (optional, for monitoring)
# =========================================================================
frontend stats
    bind 127.0.0.1:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 1s
    stats admin if LOCALHOST

